<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Setlist Tool (Preview)</title>
  <style>
    :root{
      --font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-size: 36px;
      --line-height: 1.35;
      --text-color: #ffffff;
      --shadow: 0 2px 10px rgba(0,0,0,.35);
      --visible-lines: 10;
      --scroll-speed: 38; /* px/sec */
      --pad: 10px;
    }
    html, body { height: 100%; margin: 0; background: #0b0b0b; color: #fff; }
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }

    .app{ height:100%; display:grid; grid-template-columns:420px 1fr; gap:12px; padding:12px; box-sizing:border-box; }
    body.overlay .app{ grid-template-columns:1fr; padding:0; }
    body.overlay .editor{ display:none; }
    body.overlay{ background:transparent; }

    .editor{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:12px; }
    .title{ font-weight:800; font-size:13px; opacity:.9; margin:0 0 10px; }
    label{ display:block; font-size:12px; opacity:.9; margin:10px 0 6px; }
    input, textarea{ width:100%; box-sizing:border-box; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.35); color:#fff; padding:10px; outline:none; font-size:13px; }
    textarea{ min-height:160px; resize:vertical; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button{ border:0; border-radius:12px; padding:10px; background:rgba(255,255,255,.12); color:#fff; cursor:pointer; font-weight:800; font-size:12px; }
    button:hover{ background:rgba(255,255,255,.18); }

    .previewWrap{ position:relative; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background:transparent; }
    body.overlay .previewWrap{ border:none; border-radius:0; }

    /* クロマキー用背景（曲名表示エリアだけ） */
    .viewport{
      overflow:hidden;
      padding:var(--pad);
      filter:drop-shadow(var(--shadow));
      height:calc(var(--font-size)*var(--line-height)*var(--visible-lines) + var(--pad)*2);
      background:#00ff00;
      font-family:var(--font-family);
      color:var(--text-color);
    }

    .track{ will-change:transform; transform:translateY(0px); }
    .line{ font-size:var(--font-size); line-height:var(--line-height); white-space:pre; }
    .blank{ opacity:0; }

    .badge{ position:absolute; right:10px; bottom:10px; font-size:12px; opacity:.65; background:rgba(0,0,0,.35); padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); }
  </style>
</head>
<body>
  <div class="app">
    <div class="editor">
      <p class="title">Preview（左で編集 → 右に即反映）</p>

      <label>1曲ずつ追加（Enter）</label>
      <input id="addOne" placeholder="曲名を入力してEnter" />

      <label>曲一覧（改行区切り）</label>
      <textarea id="songsInput">Song A
Song B
Song C
Song D
Song E
Song F
Song G
Song H
Song I
Song J
Song K</textarea>

      <div class="row">
        <div><label>表示行数</label><input id="visibleLines" type="number" value="10"/></div>
        <div><label>速度(px/秒)</label><input id="speed" type="number" value="38"/></div>
      </div>

      <div class="row">
        <div><label>フォントサイズ</label><input id="fontSize" type="number" value="36"/></div>
        <div><label>行間</label><input id="lineHeight" type="number" step="0.05" value="1.35"/></div>
      </div>

      <label>フォント</label>
      <input id="fontFamily" value='"Noto Sans JP", system-ui, -apple-system, "Segoe UI", sans-serif'/>

      <label>文字色</label>
      <input id="textColor" value="#ffffff"/>

      <div class="btns"><button id="applyBtn">反映</button></div>
    </div>

    <div class="previewWrap">
      <div class="viewport" id="viewport"><div class="track" id="track"></div></div>
      <div class="badge" id="badge"></div>
    </div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  document.body.classList.toggle('overlay', qs.get('overlay') === '1');

  const elTrack = document.getElementById('track');
  const elViewport = document.getElementById('viewport');
  const elBadge = document.getElementById('badge');

  const elSongsInput = document.getElementById('songsInput');
  const elAddOne = document.getElementById('addOne');
  const elFontFamily = document.getElementById('fontFamily');
  const elVisibleLines = document.getElementById('visibleLines');
  const elSpeed = document.getElementById('speed');
  const elFontSize = document.getElementById('fontSize');
  const elLineHeight = document.getElementById('lineHeight');
  const elTextColor = document.getElementById('textColor');

  let state = {
    songs: elSongsInput.value.split(/\n/),
    fontFamily: elFontFamily.value,
    visibleLines: +elVisibleLines.value,
    speed: +elSpeed.value,
    fontSize: +elFontSize.value,
    lineHeight: +elLineHeight.value,
    textColor: elTextColor.value,
  };

  function ensureFont(ff){
    const first = (ff || '').split(',')[0].trim().replace(/^['"]|['"]$/g, '');
    if (!first) return;
    const id = 'gf_' + first.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    if (document.getElementById(id)) return;
    const l = document.createElement('link');
    l.id = id;
    l.rel = 'stylesheet';
    l.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(first).replace(/%20/g,'+')}:wght@300;400;600;700&display=swap`;
    document.head.appendChild(l);
  }

  function applyVars(){
    document.documentElement.style.setProperty('--font-family', state.fontFamily);
    document.documentElement.style.setProperty('--visible-lines', state.visibleLines);
    document.documentElement.style.setProperty('--scroll-speed', state.speed);
    document.documentElement.style.setProperty('--font-size', state.fontSize + 'px');
    document.documentElement.style.setProperty('--line-height', state.lineHeight);
    document.documentElement.style.setProperty('--text-color', state.textColor);
    elViewport.style.height = (state.fontSize * state.lineHeight * state.visibleLines + 20) + 'px';
  }

  function render(lines){
    elTrack.innerHTML = '';
    lines.forEach((ln) => {
      const d = document.createElement('div');
      d.className = 'line' + (ln === '' ? ' blank' : '');
      d.textContent = (ln === '' ? ' ' : ln);
      elTrack.appendChild(d);
    });
  }

  // スクロール
  let raf = null, last = null, off = 0;
  function stop(){
    if (raf) cancelAnimationFrame(raf);
    raf = null; last = null; off = 0;
    elTrack.style.transform = 'translateY(0px)';
  }

  function start(){
    stop();

    const gap = ['', '', '']; // 仕様：つなぎ目は3行空白
    const raw = state.songs.map(s => String(s || '').trim()).filter(Boolean);

    // ★ゼロ埋め幅：曲数に合わせる（例: 9曲→1桁, 10曲→2桁, 100曲→3桁）
    const width = Math.max(1, String(raw.length).length);

    // ★自動番号付け：既存の「1. 」等は剥がして付け直す
    const numbered = raw.map((t, i) => {
      const clean = t.replace(/^\s*\d+\.\s*/, '');
      const n = String(i + 1).padStart(width, '0');
      return `${n}. ${clean}`;
    });

    elBadge.textContent = raw.length + '曲';

    if (raw.length <= state.visibleLines){
      render(numbered);
      return;
    }

    const lines = numbered.concat(gap, numbered);
    render(lines);

    const lp = state.fontSize * state.lineHeight;
    const cycle = (numbered.length + gap.length) * lp;
    const spd = state.speed;

    function tick(t){
      if (last == null) last = t;
      const dt = (t - last) / 1000;
      last = t;

      off += spd * dt;
      if (off >= cycle) off -= cycle;

      elTrack.style.transform = `translateY(${-off}px)`;
      raf = requestAnimationFrame(tick);
    }
    raf = requestAnimationFrame(tick);
  }

  function apply(){
    state = {
      songs: elSongsInput.value.split(/\n/).map(v => v.trim()).filter(Boolean),
      fontFamily: elFontFamily.value,
      visibleLines: +elVisibleLines.value,
      speed: +elSpeed.value,
      fontSize: +elFontSize.value,
      lineHeight: +elLineHeight.value,
      textColor: elTextColor.value,
    };
    ensureFont(state.fontFamily);
    applyVars();
    start();

    // 簡易セルフチェック（コンソールに出すだけ）
    // - 1曲なら「1桁」
    // - 10曲なら「01」始まり
    const test9 = Array.from({length:9}, (_,i)=>`S${i+1}`);
    const test10 = Array.from({length:10}, (_,i)=>`S${i+1}`);
    const w9 = Math.max(1, String(test9.length).length);
    const w10 = Math.max(1, String(test10.length).length);
    console.assert(String(1).padStart(w9,'0') === '1', 'pad width for 9 should be 1');
    console.assert(String(1).padStart(w10,'0') === '01', 'pad width for 10 should be 2');
  }

  document.getElementById('applyBtn').onclick = apply;
  elAddOne.onkeydown = (e) => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    const v = elAddOne.value.trim();
    if (!v) return;
    elSongsInput.value += (elSongsInput.value ? '\n' : '') + v;
    elAddOne.value = '';
    apply();
  };

  // 初期化
  ensureFont(state.fontFamily);
  applyVars();
  start();
})();
</script>
</body>
</html>
